name: Auto Commit and Push (improved)

on:
  workflow_dispatch:
    inputs:
      direct_push:
        description: 'Push direto ao branch alvo? (true/false)'
        required: false
        default: 'false'
      target_branch:
        description: 'Branch destino (ex: main)'
        required: false
        default: 'main'
      pr_branch_prefix:
        description: 'Prefixo para a branch criada (quando não for push direto)'
        required: false
        default: 'auto/update'
      commit_message:
        description: 'Mensagem de commit (use ${date} para inserir timestamp).'
        required: false
        default: 'Automated update: ${date} [skip ci]'
  schedule:
    - cron: '0 3 * * *' # diário às 03:00 UTC — ajuste conforme necessário

jobs:
  auto-commit:
    runs-on: ubuntu-latest
    outputs:
      changes_made: ${{ steps.check_changes.outputs.changes }}
    steps:
      - name: Checkout (default GITHUB_TOKEN)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Set branch name and commit message
        id: set_vars
        run: |
          TIMESTAMP=$(date -u +%Y%m%d%H%M%S)
          BRANCH="${{ github.event.inputs.pr_branch_prefix }}-${TIMESTAMP}"
          INPUT_MSG="${{ github.event.inputs.commit_message }}"
          COMMIT_MSG="${INPUT_MSG//\$\{date\}/$(date -u +%Y-%m-%dT%H:%M:%SZ)}"
          echo "branch_name=${BRANCH}" >> $GITHUB_OUTPUT
          echo "commit_msg=${COMMIT_MSG}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Make changes (example)
        id: make_changes
        run: |
          # <<< Substitua por seus comandos reais que geram/atualizam arquivos >>>
          # Exemplo de teste: gerar/atualizar changelog/test file
          echo "$(date -u) - Auto update by workflow" >> changelog.txt
          # Fim do bloco a personalizar
        shell: bash

      - name: Check for changes
        id: check_changes
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
            exit 0
          fi
          echo "changes=true" >> $GITHUB_OUTPUT
        shell: bash

      - name: Commit changes (for direct push)
        if: steps.check_changes.outputs.changes == 'true' && (github.event.inputs.direct_push == 'true')
        run: |
          git commit -m "${{ steps.set_vars.outputs.commit_msg }}"
        shell: bash

      - name: Push directly to target branch (uses REPO_PAT if set)
        if: steps.check_changes.outputs.changes == 'true' && (github.event.inputs.direct_push == 'true')
        env:
          TARGET_BRANCH: ${{ github.event.inputs.target_branch }}
          REPO_PAT: ${{ secrets.REPO_PAT }}
        run: |
          set -euo pipefail
          # Se foi fornecido REPO_PAT, configure remote para usar ele (mantendo token fora de logs).
          if [ -n "${REPO_PAT:-}" ]; then
            git remote set-url origin https://x-access-token:${REPO_PAT}@github.com/${{ github.repository }}
          fi
          git push origin "HEAD:${TARGET_BRANCH}"
        shell: bash

      - name: Create branch and open Pull Request (recommended)
        if: steps.check_changes.outputs.changes == 'true' && (github.event.inputs.direct_push != 'true')
        uses: peter-evans/create-pull-request@v5
        with:
          branch: ${{ steps.set_vars.outputs.branch_name }}
          title: ${{ steps.set_vars.outputs.commit_msg }}
          body: This PR was created automatically by the CI workflow.
          commit-message: ${{ steps.set_vars.outputs.commit_msg }}
          base: ${{ github.event.inputs.target_branch }}
          labels: automated, ci
          maintainer-can-modify: true

      - name: No changes - finish
        if: steps.check_changes.outputs.changes != 'true'
        run: echo "No changes detected — nothing to commit or push."
        shell: bash
