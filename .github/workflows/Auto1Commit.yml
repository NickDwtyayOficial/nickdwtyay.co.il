name: Auto Commit and Push (improved)

on:
  workflow_dispatch:
    inputs:
      direct_push:
        description: 'Push direto ao branch alvo? (true/false)'
        required: false
        default: 'false'
      target_branch:
        description: 'Branch destino (ex: main)'
        required: false
        default: 'main'
      pr_branch_prefix:
        description: 'Prefixo para a branch criada (quando não for push direto)'
        required: false
        default: 'auto/update'
      commit_message:
        description: 'Mensagem de commit (use ${date} para inserir timestamp).'
        required: false
        default: 'Automated update: ${date} [skip ci]'
  schedule:
    - cron: '0 3 * * *' # diário às 03:00 UTC — ajuste conforme necessário

jobs:
  auto-commit:
    runs-on: ubuntu-latest
    outputs:
      changes_made: ${{ steps.check_changes.outputs.changes }}
    steps:
      # Checkout padrão (usado quando NÃO for push direto ou quando REPO_PAT não for fornecido)
      - name: Checkout (default GITHUB_TOKEN)
        id: checkout_default
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        shell: bash

      - name: Set branch name and commit message
        id: set_vars
        run: |
          TIMESTAMP=$(date -u +%Y%m%d%H%M%S)
          BRANCH="${{ github.event.inputs.pr_branch_prefix }}-${TIMESTAMP}"
          INPUT_MSG="${{ github.event.inputs.commit_message }}"
          COMMIT_MSG="${INPUT_MSG//\$\{date\}/$(date -u +%Y-%m-%dT%H:%M:%SZ)}"
          echo "branch_name=${BRANCH}" >> $GITHUB_OUTPUT
          echo "commit_msg=${COMMIT_MSG}" >> $GITHUB_OUTPUT
        shell: bash

      - name: Make changes (example)
        id: make_changes
        run: |
          # <<< SUBSTITUA por seus comandos que geram/atualizam arquivos do projeto >>>
          # Exemplo de teste: cria/atualiza changelog.txt
          echo "$(date -u) - Auto update by workflow" >> changelog.txt
        shell: bash

      - name: Check for changes
        id: check_changes
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
            exit 0
          fi
          echo "changes=true" >> $GITHUB_OUTPUT
        shell: bash

      # Commit local (apenas quando faremos push direto)
      - name: Commit changes (for direct push)
        if: steps.check_changes.outputs.changes == 'true' && github.event.inputs.direct_push == 'true'
        run: |
          git commit -m "${{ steps.set_vars.outputs.commit_msg }}"
        shell: bash

      # If doing direct_push=true, re-checkout with PAT so push is done by PAT (not GITHUB_TOKEN)
      - name: Checkout with REPO_PAT for direct push
        if: github.event.inputs.direct_push == 'true'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.REPO_PAT }}
          fetch-depth: 0
          persist-credentials: true

      - name: Push directly to target branch (uses REPO_PAT if provided)
        if: steps.check_changes.outputs.changes == 'true' && github.event.inputs.direct_push == 'true'
        env:
          TARGET_BRANCH: ${{ github.event.inputs.target_branch }}
          # REPO_PAT is referenced only via ${{ secrets.REPO_PAT }} above (not echoed)
        run: |
          set -euo pipefail
          # Push: when checkout used token: ${{ secrets.REPO_PAT }}, git push will use that credential
          git push origin "HEAD:${TARGET_BRANCH}"
        shell: bash

      - name: Create branch and open Pull Request (recommended fallback)
        if: steps.check_changes.outputs.changes == 'true' && github.event.inputs.direct_push != 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          branch: ${{ steps.set_vars.outputs.branch_name }}
          title: ${{ steps.set_vars.outputs.commit_msg }}
          body: This PR was created automatically by the CI workflow.
          commit-message: ${{ steps.set_vars.outputs.commit_msg }}
          base: ${{ github.event.inputs.target_branch }}
          labels: automated, ci
          maintainer-can-modify: true

      - name: No changes - finish
        if: steps.check_changes.outputs.changes != 'true'
        run: echo "No changes detected — nothing to commit or push."
        shell: bash
