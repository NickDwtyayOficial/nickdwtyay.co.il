name: AGENT-0 - C# .NET no GitHub Actions (cria zoutbrout.php)
on:
  workflow_dispatch:  # Rode manual pra testar

jobs:
  gerar-com-csharp:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repositÃ³rio
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'  # VersÃ£o estÃ¡vel e rÃ¡pida

      - name: Cria projeto console C# temporÃ¡rio
        run: |
          mkdir GrokAgent
          cd GrokAgent
          dotnet new console -o GrokAgentApp
          cd GrokAgentApp

      - name: Adiciona cÃ³digo C# e roda
        env:
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
        run: |
          cd GrokAgent/GrokAgentApp

          # CÃ³digo C# completo (substitui Program.cs)
          cat > Program.cs << 'EOF'
using System;
using System.Net.Http;
using System.Net.Http.Headers;
using System.Text;
using System.Text.Json;
using System.IO;
using System.Threading.Tasks;

class Program
{
    static async Task Main(string[] args)
    {
        Console.WriteLine("ðŸ”¹ Iniciando Grok Agent em C#...");

        string key = Environment.GetEnvironmentVariable("GROK_API_KEY");
        if (string.IsNullOrEmpty(key))
        {
            Console.WriteLine("âŒ GROK_API_KEY nÃ£o encontrada.");
            return;
        }

        // LÃª o arquivo original
        string originalPath = "../../api/index.php";
        string original = "";
        if (File.Exists(originalPath))
        {
            original = File.ReadAllText(originalPath);
            Console.WriteLine("âœ… Arquivo lido.");
        }
        else
        {
            Console.WriteLine("âš ï¸ api/index.php nÃ£o encontrado.");
        }

        // Prepara payload
        var payload = new
        {
            model = "grok-4-latest",
            input = new[]
            {
                new { role = "user", content = $"Melhore esse cÃ³digo:\n\n{original}\n\nAdicione CSRF, performance, SEO, GDPR, acessibilidade. Retorne SÃ“ o cÃ³digo PHP/HTML/JS corrigido. Sem explicaÃ§Ãµes." }
            },
            temperature = 0.3,
            max_tokens = 12000
        };

        using var client = new HttpClient();
        client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", key);
        client.DefaultRequestHeaders.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

        var content = new StringContent(JsonSerializer.Serialize(payload), Encoding.UTF8, "application/json");

        Console.WriteLine("ðŸ”¹ Chamando xAI API...");
        var response = await client.PostAsync("https://api.x.ai/v1/responses", content);

        if (!response.IsSuccessStatusCode)
        {
            Console.WriteLine($"âŒ Erro API: {response.StatusCode} - {await response.Content.ReadAsStringAsync()}");
            return;
        }

        var json = await response.Content.ReadAsStringAsync();
        Console.WriteLine("Resposta crua: " + json.Substring(0, Math.Min(500, json.Length)) + "...");

        // Parse simples (ajuste se o formato mudar)
        var data = JsonDocument.Parse(json);
        string novoCodigo = "";
        if (data.RootElement.TryGetProperty("output", out var output) &&
            output[0 0].TryGetProperty("text", out var textElem))
        {
            novoCodigo = textElem.GetString() ?? "";
        }

        if (string.IsNullOrEmpty(novoCodigo))
        {
            Console.WriteLine("âŒ NÃ£o conseguiu extrair o cÃ³digo.");
            return;
        }

        // Salva novo arquivo
        string newPath = "../../api/zoutbrout.php";
        File.WriteAllText(newPath, novoCodigo);
        Console.WriteLine("âœ… zoutbrout.php criado!");

        // Commit e push
        Console.WriteLine("ðŸ”¹ Commitando...");
        Directory.SetCurrentDirectory("../../");
        await RunGit("add api/zoutbrout.php");
        await RunGit("commit -m \"Grok via C#: versÃ£o melhorada em zoutbrout.php\"");
        await RunGit("push origin main");
        Console.WriteLine("ðŸŽ‰ Tudo enviado!");
    }

    static async Task RunGit(string cmd)
    {
        var process = new System.Diagnostics.Process
        {
            StartInfo = new System.Diagnostics.ProcessStartInfo
            {
                FileName = "git",
                Arguments = cmd,
                RedirectStandardOutput = true,
                UseShellExecute = false,
                CreateNoWindow = true
            }
        };
        process.Start();
        await process.WaitForExitAsync();
        Console.WriteLine($"Git {cmd}: {await process.StandardOutput.ReadToEndAsync()}");
    }
}
EOF

          # Roda o app
          dotnet run
        shell: bash