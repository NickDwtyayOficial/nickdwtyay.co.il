- name: Chama Grok - Responses API (endpoint atual)
        env:
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
        run: |
          set -e  # Para se qualquer comando falhar, o job para

          echo "Chamando https://api.x.ai/v1/responses ..."

          RESPONSE=$(curl -s -X POST https://api.x.ai/v1/responses \
            -H "Authorization: Bearer $GROK_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "model": "grok-4-latest",
              "input": [
                {
                  "role": "user",
                  "content": "Aqui está o conteúdo atual de api/index.php:\n\n$(cat api/index.php 2>/dev/null || echo 'Arquivo não encontrado')\n\nMelhore tudo: adicione proteção CSRF, otimize performance (menos requests, minify onde possível), melhore SEO (mais meta tags úteis), melhore privacidade (GDPR-compliant cookies), melhore acessibilidade. Retorne SOMENTE o código PHP/HTML/JS completo corrigido, sem explicações, sem markdown, sem texto fora das tags. Não adicione comentários."
                }
              ],
              "temperature": 0.3,
              "max_tokens": 12000
            }')

          echo "==== RESPOSTA CRUA DA API (RAW) ===="
          echo "$RESPONSE" | head -c 2000  # limita pra não explodir o log
          echo ""
          echo "====================================="

          # Extrai o texto da resposta (formato mais comum da Responses API)
          CONTENT=$(echo "$RESPONSE" | jq -r '.output[0].content[0].text // .output[0].text // empty' 2>/dev/null || echo "")

          if [ -z "$CONTENT" ]; then
            echo "ERRO: Conteúdo vazio ou jq não encontrou o campo esperado."
            echo "Possíveis causas:"
            echo "1. GROK_API_KEY inválida ou não configurada"
            echo "2. Model 'grok-4-latest' não disponível na tua conta"
            echo "3. Rate limit atingido"
            echo "4. Erro 400/401/403/410 na API"
            exit 0
          fi

          echo "==== CONTEÚDO EXTRAÍDO COM SUCESSO ===="
          echo "$CONTENT" | head -n 20
          echo "====================================="

          echo "$CONTENT" > api/index.php.new
          mv api/index.php.new api/index.php
          echo "api/index.php sobrescrito com sucesso."