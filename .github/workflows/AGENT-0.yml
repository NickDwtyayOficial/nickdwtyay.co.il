name: AGENT-0 - Automatizador Completo com OpenAI API

on:
  schedule:
    - cron: '0 */6 * * *'  # Executa a cada 6 horas
  workflow_dispatch:      # Permite execução manual

jobs:
  automatizar-repo:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Permissão para editar e commitar arquivos

    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Pega histórico completo para diffs

      - name: Chama OpenAI API para analisar e melhorar o repositório
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}  # Adicione essa secret no Settings > Secrets do repo
        run: |
          echo "Iniciando automação completa via OpenAI API..."
          
          # Chamada à API OpenAI para gerar melhorias
          RESPONSE=$(curl -s -X POST https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "model": "gpt-4o",  # Use gpt-4o ou gpt-4-turbo para melhor performance
              "messages": [
                {
                  "role": "system",
                  "content": "Você é um agente de automação que melhora repositórios GitHub. Analise o código, sugira e aplique melhorias."
                },
                {
                  "role": "user",
                  "content": "Analise TODO o repositório nickdwtyay.co.il (incluindo api/index.php, index.html, CSS, JS, configs Vercel/Supabase). Gere um SCRIPT BASH executável que aplique melhorias para: performance (minify, cache), SEO (meta tags), acessibilidade (ARIA), segurança (CSRF, headers), privacidade (GDPR). Retorne APENAS o script bash completo (começando com #!/bin/bash), sem explicações fora do código."
                }
              ],
              "temperature": 0.5,
              "max_tokens": 8000
            }' | jq -r '.choices[0].message.content // empty')
          
          echo "Resposta da OpenAI API (primeiras linhas para debug):"
          echo "$RESPONSE" | head -n 20
          
          if [ -z "$RESPONSE" ] || [ "$RESPONSE" = "null" ]; then
            echo "ERRO: Resposta vazia ou inválida da API. Verifique a chave ou model."
            exit 0
          fi
          
          # Salva e executa o script gerado pela API
          echo "$RESPONSE" > improve_script.sh
          chmod +x improve_script.sh
          ./improve_script.sh || { echo "Falha ao executar script da API"; exit 1; }
          echo "Melhorias aplicadas automaticamente."

      - name: Commit e Push todas as mudanças
        run: |
          git config --global user.name "Agent-0 Automatizador"
          git config --global user.email "agent@dwtyay.co.il"
          
          # Adiciona todas as mudanças no repositório (automatiza tudo)
          git add .
          
          # Só commita se houver mudanças reais e evita loops infinitos
          git diff --cached --quiet && echo "Nenhuma mudança detectada" || {
            LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
            if [[ "$LAST_COMMIT_MSG" == *"Automatizador"* ]]; then
              echo "Último commit foi do agente. Evitando loop."
            else
              git commit -m "Automação completa via OpenAI: otimizações gerais no repositório (performance, SEO, segurança, etc.)"
              git push origin HEAD:main || echo "Push falhou - verifique permissões"
            fi
          fi