name: AGENT-0 - Grok Direto
on:
  schedule:
    - cron: '*/30 * * * *'  # a cada 30 min, pra testar
  workflow_dispatch:
jobs:
  grok:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Chama Grok e melhora
        env:
          GROK_KEY: ${{ secrets.GROK_API_KEY }}
        run: |
          RES=$(curl -s https://api.x.ai/v1/chat/completions \
            -H "Authorization: Bearer $GROK_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "model": "grok-4-latest",
              "messages": [{"role": "user", "content": "Aqui está api/index.php atual: . Melhora tudo: CSRF, performance, SEO, segurança. Retorna SOMENTE o código PHP/HTML novo, sem texto, sem markdown, sem nada."} 0].message.content // ""')

          if ; then
            echo "Eu não respondi, caralho."
            exit 0
          fi

          echo "$RES" > api/index.php
          git add api/index.php
          git commit -m "Grok melhorou api/index.php" || true
          git push origin main || true