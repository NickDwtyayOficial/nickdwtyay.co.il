name: AGENT-0 - Melhorador Automático

on:
  schedule:
    - cron: '0 */6 * * *'  # A cada 6h
  workflow_dispatch:

jobs:
  improve:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Chama Grok API
        env:
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
        run: |
          RESPONSE=$(curl -s -X POST https://api.x.ai/v1/chat/completions \
            -H "Authorization: Bearer $GROK_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "model": "grok-4-latest",
              "messages": [{"role": "user", "content": "Melhore api/index.php para: performance rápida, SEO bom, acessibilidade, segurança (adicione CSRF), privacidade (GDPR cookies). Retorne SOMENTE o código PHP/HTML/JS completo, sem nada fora."}],
              "temperature": 0.3,
              "max_tokens": 8000
            }' | jq -r '.choices[0].message.content // empty')
          
          if ; then
            echo "Resposta vazia - API falhou."
            exit 0
          fi
          
          echo "$RESPONSE" > api/index.php.new
          mv api/index.php.new api/index.php
          echo "Arquivo atualizado."

      - name: Commit automático
        run: |
          git config --global user.name "Agent-0"
          git config --global user.email "agent@dwtyay.co.il"
          git add api/index.php
          git diff --cached --quiet || git commit -m "Grok melhorou api/index.php automaticamente"
          git push origin HEAD:main || echo "Sem push"