name: AGENT-0 - Cria zoutbrout.php (seguro)
on: workflow_dispatch
jobs:
  gerar:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Python: lê index.php, melhora, salva zoutbrout.php
        run: |
          pip install requests

          python -c "
import requests
import sys

# Lê original
try:
    with open('api/index.php') as f:
        original = f.read()
except Exception as e:
    print('ERRO: ', e)
    sys.exit(1)

print('Chamando Grok...')

# Chama API
resp = requests.post(
    'https://api.x.ai/v1/responses',
    headers={
        'Authorization': f'Bearer {os.getenv(\"GROK_API_KEY\")}',
        'Content-Type': 'application/json'
    },
    json={
        'model': 'grok-4-latest',
        'input': [{'role': 'user', 'content': f'Melhore isso:\n\n{original}\n\nAdicione CSRF, performance, SEO, GDPR, acessibilidade. Retorne SÓ o código. Nada mais.'}],
        'temperature': 0.2
    }
)

# Extrai
data = resp.json()
try:
    novo_codigo = data [0] [0] except Exception as e:
    print('Falhou no parse:', e)
    print('Resposta:', resp.text)
    sys.exit(1)

# Salva no novo arquivo
with open('api/zoutbrout.php', 'w') as f:
    f.write(novo_codigo)

# Comita
subprocess.run(['git', 'add', 'api/zoutbrout.php' 'git', 'commit', '-m', 'Grok: criou versão melhorada (zoutbrout.php)'], check=True)
subprocess.run( , check=True)

print('✅ Pronto. zoutbrout.php criado e enviado.')
          "
        env:
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}