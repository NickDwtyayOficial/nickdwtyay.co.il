name: ğŸ¤– Agent-0 Auto Update
on:
  workflow_dispatch:
    inputs:
      direct_push:
        description: 'ğŸš€ Push direto para branch alvo (true/false)'
        required: true
        default: 'false'
      target_branch:
        description: 'ğŸ¯ Branch alvo para push ou PR'
        required: true
        default: 'main'

jobs:
  update-agent:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      # ğŸ“¦ PASSO 1: Checkout do repositÃ³rio
      - name: ğŸ”µ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.REPO_PAT }}
          fetch-depth: 0
      
      # ğŸ‘¤ PASSO 2: Configurar identidade Git
      - name: ğŸŸ¢ Configurar identidade Git
        run: |
          git config user.name "Agent-0 Bot"
          git config user.email "agent-0-bot@users.noreply.github.com"
          echo "âœ… Git configurado com sucesso!"
      
      # âš™ï¸ PASSO 3: Setup Node.js (se necessÃ¡rio)
      - name: ğŸŸ£ Verificar package.json
        id: check-package
        run: |
          if [ -f "package.json" ]; then
            echo "package_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… package.json encontrado!"
          else
            echo "package_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ package.json nÃ£o encontrado - pulando setup Node.js"
          fi
      
      - name: ğŸŸ¡ Setup Node.js
        if: steps.check-package.outputs.package_exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ”µ Install dependencies
        if: steps.check-package.outputs.package_exists == 'true'
        run: |
          echo "ğŸ“¦ Instalando dependÃªncias..."
          npm ci
          echo "âœ… DependÃªncias instaladas!"
      
      # ğŸ”„ PASSO 4: Gerar/Atualizar conteÃºdo (se necessÃ¡rio)
      - name: ğŸŸ¢ Verificar scripts de geraÃ§Ã£o
        id: check-scripts
        if: steps.check-package.outputs.package_exists == 'true'
        run: |
          if grep -q '"generate"' package.json || grep -q '"build"' package.json; then
            echo "scripts_exist=true" >> $GITHUB_OUTPUT
            echo "âœ… Scripts de geraÃ§Ã£o encontrados!"
          else
            echo "scripts_exist=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Nenhum script de geraÃ§Ã£o encontrado - pulando"
          fi
      
      - name: ğŸ”µ Executar geraÃ§Ã£o (se existir)
        if: steps.check-scripts.outputs.scripts_exist == 'true' && steps.check-package.outputs.package_exists == 'true'
        run: |
          echo "ğŸ”¨ Executando scripts de geraÃ§Ã£o..."
          if npm run generate 2>/dev/null; then
            echo "âœ… Script 'generate' executado!"
          elif npm run build 2>/dev/null; then
            echo "âœ… Script 'build' executado!"
          else
            echo "âš ï¸ Nenhum script executado - continuando..."
          fi
      
      # ğŸ’¾ PASSO 5: Commit e Push
      - name: ğŸŸ£ Commit e Push
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ’¾ Salvando alteraÃ§Ãµes..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Adicionar todas as alteraÃ§Ãµes
          git add .
          
          # Verificar se hÃ¡ alteraÃ§Ãµes para commitar
          if git diff --cached --quiet; then
            echo "âš ï¸ NENHUMA alteraÃ§Ã£o detectada - nada para commitar!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 0
          fi
          
          # Commit
          COMMIT_MSG="ğŸ¤– Agent-0 atualizado: $(date '+%Y-%m-%d %H:%M:%S')"
          git commit -m "$COMMIT_MSG"
          echo "âœ… Commit criado: $COMMIT_MSG"
          
          # Push baseado no input
          if [ "${{ github.event.inputs.direct_push }}" == "true" ]; then
            echo "ğŸš€ Push DIRETO para ${{ github.event.inputs.target_branch }}"
            git push origin ${{ github.event.inputs.target_branch }}
            echo "âœ… Push direto concluÃ­do com sucesso!"
          else
            BRANCH_NAME="${{ github.event.inputs.target_branch }}-agent-update"
            echo "ğŸ”€ Push para branch: $BRANCH_NAME"
            git push origin HEAD:$BRANCH_NAME
            echo "âœ… Branch criado: $BRANCH_NAME"
            echo "â¡ï¸ Crie um Pull Request para merge!"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      # âœ… PASSO 6: NotificaÃ§Ã£o de sucesso
      - name: ğŸŸ¢ âœ… Workflow concluÃ­do com sucesso!
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ AGENT-0 ATUALIZADO COM SUCESSO!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Status: âœ… SUCESSO"
          echo "ğŸ“… Data: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      # âŒ PASSO 7: NotificaÃ§Ã£o de falha
      - name: ğŸ”´ âŒ Workflow falhou!
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âš ï¸ ATENÃ‡ÃƒO: OCORREU UM ERRO!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Status: âŒ FALHA"
          echo "ğŸ” Verifique os logs acima para detalhes"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
