name: AGENT-0 - Cria zoutbrout.php (vers√£o corrigida)
on:
  workflow_dispatch:

jobs:
  gerar:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Instala depend√™ncias e roda Python
        run: |
          pip install requests

          python - <<EOF
import requests
import sys
import subprocess
import os

print("üîπ Lendo api/index.php...")
try:
    with open('api/index.php', 'r') as f:
        original = f.read()
except Exception as e:
    print("‚ùå Erro ao ler arquivo:", e)
    sys.exit(1)

print("üîπ Chamando Grok API...")
resp = requests.post(
    'https://api.x.ai/v1/responses',
    headers={
        'Authorization': f'Bearer {os.getenv("GROK_API_KEY")}',
        'Content-Type': 'application/json'
    },
    json={
        'model': 'grok-4-latest',
        'input': [
            {
                'role': 'user',
                'content': f'Melhore esse c√≥digo completo:\n\n{original}\n\nAdicione CSRF, performance, SEO, GDPR, acessibilidade. Retorne S√ì o c√≥digo PHP/HTML/JS corrigido. Sem explica√ß√µes, sem markdown, sem texto extra.'
            }
        ],
        'temperature': 0.3,
        'max_tokens': 12000
    }
)

if resp.status_code != 200:
    print("‚ùå Erro na API:", resp.status_code, resp.text)
    sys.exit(1)

data = resp.json()
try:
    novo_codigo = data['output'][0]['content'][0]['text']
except KeyError as e:
    print("‚ùå Parse falhou. Chave n√£o encontrada:", e)
    print("Resposta completa:", data)
    sys.exit(1)

print("‚úÖ C√≥digo gerado com sucesso. Salvando em api/zoutbrout.php...")
with open('api/zoutbrout.php', 'w') as f:
    f.write(novo_codigo)

print("üîπ Comitando altera√ß√µes...")
subprocess.run(['git', 'add', 'api/zoutbrout.php'], check=True)
subprocess.run(['git', 'commit', '-m', 'Grok: vers√£o melhorada salva em zoutbrout.php'], check=True)
subprocess.run(['git', 'push', 'origin', 'main'], check=True)

print("üéâ Feito! zoutbrout.php criado e enviado.")
EOF
        env:
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}