name: AGENT-0 - Melhorador Automático

on:
  schedule:
    - cron: '0 0 * * *'  # Todo dia à meia-noite (UTC)
  workflow_dispatch:      # Permite rodar manualmente

jobs:
  improve-site:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1

      - name: Chama Grok API para melhorar index.html
        env:
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
        run: |
          # Prompt para IA devolver SÓ HTML limpo
          RESPONSE=$(curl -s -X POST https://api.x.ai/v1/chat/completions \
            -H "Authorization: Bearer $GROK_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "model": "grok-beta",
              "messages": [
                {
                  "role": "user",
                  "content": "Analise e melhore o conteúdo do index.html atual para: 1) carregamento mais rápido, 2) melhor SEO, 3) melhor acessibilidade. Retorne APENAS o código HTML completo e corrigido, sem explicações, sem markdown, sem texto adicional fora das tags HTML."
                }
              ],
              "temperature": 0.4,
              "max_tokens": 4000
            }' | jq -r '.choices[0].message.content // empty')

          # Verifica se veio algo útil
          if [ -z "$RESPONSE" ] || [ "$RESPONSE" = "null" ]; then
            echo "Resposta da IA vazia ou inválida. Nada alterado."
            exit 0
          fi

          echo "$RESPONSE" > novo_index.html
          mv novo_index.html index.html || { echo "Falha ao mover arquivo"; exit 1; }

      - name: Configura Git e commit/push se houver mudanças
        run: |
          git config --global user.name "Agent-0"
          git config --global user.email "agent@dwtyay.co.il"
          
          git add index.html   # <-- só o arquivo que a IA mexeu
          
          # Só commita se mudou de verdade
          git diff --cached --quiet && echo "Nenhuma mudança real no index.html" || git commit -m "Atualização automática: IA otimizou index.html (performance, SEO, acessibilidade)"
          
          git push origin HEAD:main || echo "Push falhou ou sem mudanças"